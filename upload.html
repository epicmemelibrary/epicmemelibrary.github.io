<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Create Meme</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #previewArea img { max-width: 400px; display: block; margin-top: 20px; }
  </style>
</head>
<body>

<h1>Create a Brain Health Meme</h1>

<h3>Select a sample image</h3>
<select id="sampleSelect">
  <option value="">Loading samples...</option>
</select>

<p><b>OR upload your own image</b></p>
<input type="file" id="fileInput" accept="image/*">

<hr>

<h3>Captions</h3>
<label>Top Caption</label><br>
<input type="text" id="topText" placeholder="Top caption"><br><br>

<label>Bottom Caption</label><br>
<input type="text" id="bottomText" placeholder="Bottom caption"><br><br>

<button id="previewBtn">Preview Meme</button>
<button id="submitBtn">Submit Meme</button>

<div id="previewArea"></div>

<canvas id="memeCanvas" style="display:none;"></canvas>

<script>
// -------------------------
// CONFIG â€” replace with your Google Form entry ID
// -------------------------
const GOOGLE_FORM_ACTION = "YOUR_GOOGLE_FORM_POST_URL";
const ENTRY_JSON = "entry.123456789"; // Replace with your real entry ID

// -------------------------
// LOAD SAMPLE IMAGES
// -------------------------
async function loadSampleImages() {
  const response = await fetch(
    "https://api.github.com/repos/brainhealth-meme-library/brainhealth-meme-library.github.io/contents/samples"
  );

  const select = document.getElementById("sampleSelect");

  if (!response.ok) {
    select.innerHTML = "<option>Error loading samples</option>";
    return;
  }

  const files = await response.json();
  select.innerHTML = "<option value=''>Choose a sample...</option>";

  files.forEach(file => {
    if (file.type === "file") {
      const option = document.createElement("option");
      option.value = file.download_url;
      option.textContent = file.name;
      select.appendChild(option);
    }
  });
}

loadSampleImages();

// -------------------------
// PREVIEW MEME
// -------------------------
document.getElementById("previewBtn").onclick = generatePreview;

function generatePreview() {
  const topText = document.getElementById("topText").value;
  const bottomText = document.getElementById("bottomText").value;

  const sampleURL = document.getElementById("sampleSelect").value;
  const file = document.getElementById("fileInput").files[0];

  if (!sampleURL && !file) {
    alert("Choose a sample image or upload one");
    return;
  }

  const img = new Image();
  img.crossOrigin = "anonymous";

  img.src = file ? URL.createObjectURL(file) : sampleURL;

  img.onload = () => {
    const canvas = document.getElementById("memeCanvas");
    const ctx = canvas.getContext("2d");

    canvas.width = img.width;
    canvas.height = img.height;

    ctx.drawImage(img, 0, 0);

    ctx.font = `${canvas.width / 10}px Impact`;
    ctx.fillStyle = "white";
    ctx.strokeStyle = "black";
    ctx.lineWidth = canvas.width / 100;
    ctx.textAlign = "center";

    ctx.fillText(topText.toUpperCase(), canvas.width / 2, canvas.height * 0.1);
    ctx.strokeText(topText.toUpperCase(), canvas.width / 2, canvas.height * 0.1);

    ctx.fillText(bottomText.toUpperCase(), canvas.width / 2, canvas.height * 0.95);
    ctx.strokeText(bottomText.toUpperCase(), canvas.width / 2, canvas.height * 0.95);

    const preview = document.getElementById("previewArea");
    preview.innerHTML = "";
    const imgPreview = new Image();
    imgPreview.src = canvas.toDataURL("image/png");
    preview.appendChild(imgPreview);
  };
}

// -------------------------
// SUBMIT JSON TO GOOGLE FORM
// -------------------------
document.getElementById("submitBtn").onclick = submitToGoogleForm;

async function submitToGoogleForm() {
  const top = document.getElementById("topText").value;
  const bottom = document.getElementById("bottomText").value;

  const sampleURL = document.getElementById("sampleSelect").value;
  const file = document.getElementById("fileInput").files[0];

  let baseImageName = "";
  let uploadedImageBase64 = "";

  if (file) {
    baseImageName = file.name;
    uploadedImageBase64 = await fileToBase64(file);
  } else if (sampleURL) {
    baseImageName = sampleURL.split("/").pop();
  } else {
    alert("Choose or upload an image");
    return;
  }

  const previewCanvas = document.getElementById("memeCanvas");
  const previewBase64 = previewCanvas.toDataURL("image/png");

  const memeJSON = {
    top,
    bottom,
    baseImage: baseImageName,
    uploadedImageBase64,
    previewBase64,
    timestamp: Date.now()
  };

  const formData = new FormData();
  formData.append(ENTRY_JSON, JSON.stringify(memeJSON));

  await fetch(GOOGLE_FORM_ACTION, {
    method: "POST",
    mode: "no-cors",
    body: formData
  });

  alert("Submitted! Thank you!");
}

// -------------------------
// HELPER: Convert file to base64
// -------------------------
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}
</script>

</body>
</html>

